pipeline {
    agent any
    tools {
        nodejs 'nodejs-default' // Use the name you gave your NodeJS configuration
    }
    environment {
        BASE_URL = 'https://api.demoblaze.com'  // Replace with your actual API base URL
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/ayamaher88/Testing-E-Commerce-.git'
            }
        }

        stage('Run API Tests with Newman') {
            steps {
                echo 'Running API Tests with Newman...'
                bat 'npm install -g newman'
                script {
                    def newmanResult = bat(
                        script: "newman run 'API Testing/Demoblaze API Tests.postman_collection.json' -e <(echo '{\"values\":[{\"key\":\"baseUrl\",\"value\":\"${env.BASE_URL}\",\"enabled\":true}]}')",
                        returnStatus: true
                    )
                    if (newmanResult != 0) {
                        error "Newman tests failed!"
                    }
                }
                // You can add reporter options here if needed
                // Example with HTML Extra reporter:
                // bat "newman run 'API Testing/Demoblaze API Tests.postman_collection.json' -e <(echo '{\"values\":[{\"key\":\"baseUrl\",\"value\":\"${env.BASE_URL}\",\"enabled\":true}]}') -r htmlextra --reporter-htmlextra-export report.html"
            }
        }

        stage('Publish API Test Results (Optional)') {
            steps {
                echo 'Publishing API Test Results (if any)...'
                // You can configure publishing reports here, for example, using the HTML Publisher Plugin
                // if you are generating an HTML report with Newman.
                // Example:
                // publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: '.', reportFiles: 'report.html', reportName: 'Newman API Test Report'])
            }
        }

        stage('Post-Build Actions') {
            steps {
                script {
                    echo 'Performing post-build actions...'
                    // Add your actual post-build steps here
                }
            }
        }
    }
}
