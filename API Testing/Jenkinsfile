pipeline {
    agent any
    tools {
        nodejs 'nodejs-default'
    }
    environment {
        BASE_URL = 'https://api.demoblaze.com'
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/ayamaher88/Testing-E-Commerce-.git'
            }
        }

        stage('Run API Tests with Newman') {
            steps {
                echo 'Running API Tests with Newman...'
                bat 'npm install -g newman'
                script {
                    def environmentJson = """
                    {
                        "values": [
                            {
                                "key": "baseUrl",
                                "value": "${env.BASE_URL}",
                                "enabled": true
                            }
                        ]
                    }
                    """
                    writeFile file: 'environment.json', text: environmentJson

                    def newmanResult = bat(
                        script: "newman run \"API Testing/Demoblaze API Tests.postman_collection.json\" -e environment.json",
                        returnStatus: true
                    )
                    deleteDir() // Clean up the temporary environment file

                    if (newmanResult != 0) {
                        error "Newman tests failed!"
                    }
                }
            }
        }

        stage('Publish API Test Results (Optional)') {
            steps {
                echo 'Publishing API Test Results (if any)...'
                // ... (reporting configuration as needed)
            }
        }

        stage('Post-Build Actions') {
            steps {
                script {
                    echo 'Performing post-build actions...'
                    // Add your actual post-build steps here
                }
            }
        }
    }
}
